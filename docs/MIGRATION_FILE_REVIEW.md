# üìã Revisi√≥n: supabase/migrations/001_initial_schema.sql

**Fecha**: January 9, 2026
**Estado del Archivo**: Incompleto pero correcto
**Recomendaci√≥n**: Ampliar seg√∫n arquitectura + definir opci√≥n

---

## ‚úÖ Lo Que Est√° BIEN

1. **Estructura b√°sica correcta**
   - ‚úÖ CREATE TABLE syntax correcto
   - ‚úÖ RLS habilitado en ambas tablas
   - ‚úÖ Constrains (CHECK) en columnas num√©ricas
   - ‚úÖ Foreign keys correctamente definidas

2. **Campos esenciales presentes**
   - ‚úÖ products: id, name, price, category
   - ‚úÖ transactions: id, student_id, product_id, amount
   - ‚úÖ Timestamps autom√°ticos (created_at)

3. **Seguridad base**
   - ‚úÖ RLS policies implementadas
   - ‚úÖ Comentarios explicativos √∫tiles
   - ‚úÖ Checks para valores no-negativos

4. **Enfoque pragm√°tico**
   - ‚úÖ Minimalista (solo lo necesario para MVP)
   - ‚úÖ F√°cil de extender despu√©s

---

## ‚ö†Ô∏è Problemas Identificados

### 1. **concessionaire_id sin Foreign Key**

**Problema**:
```sql
concessionaire_id bigint -- Podr√≠a ser una FK en el futuro
```

**Impacto**:
- ‚ùå Sin integridad referencial
- ‚ùå Datos hu√©rfanos posibles
- ‚ùå Queries complejas sin relaci√≥n

**Soluci√≥n** (requiere tabla `operating_units`):
```sql
-- Primero crear:
CREATE TABLE public.operating_units (
    id bigint generated by default as identity primary key,
    name text not null,
    school_id UUID not null
);

-- Luego:
ALTER TABLE products 
ADD CONSTRAINT fk_unit 
FOREIGN KEY (concessionaire_id) REFERENCES operating_units(id);
```

---

### 2. **Falta Field: school_id**

**Problema**:
- ‚ùå Sin field para multi-tenant
- ‚ùå No se puede filtrar por escuela
- ‚ùå Inseguro: datos de escuelas mezclados

**Ejemplo del riesgo**:
```sql
-- Sin school_id, esto retorna productos de TODAS las escuelas
SELECT * FROM products WHERE category = 'CAFETERIA';

-- Con school_id (seguro):
SELECT * FROM products WHERE school_id = '123' AND category = 'CAFETERIA';
```

**Soluci√≥n**: Agregar a ambas tablas:
```sql
school_id UUID NOT NULL DEFAULT gen_random_uuid(),

-- O mejor:
school_id UUID NOT NULL REFERENCES public.schools(id)
```

---

### 3. **RLS Policies Incompletas**

**Problema actual**:
```sql
-- Products: Todos pueden leer todos los productos
CREATE POLICY "Allow public read access to products" ON public.products 
FOR SELECT USING (true);

-- Transactions: Solo estudiante ve sus propias transacciones
CREATE POLICY "Allow users to read their own transactions" ON public.transactions
FOR SELECT
USING (auth.uid() = student_id);
```

**Riesgos**:
- ‚ùå No hay INSERT/UPDATE/DELETE policies
- ‚ùå Productos se ven sin filtro por escuela
- ‚ùå Los padres no pueden ver transacciones de sus hijos

**Soluci√≥n completa**:
```sql
-- Para products: Ver solo de tu escuela
CREATE POLICY "Users see products of their school" ON public.products
FOR SELECT
USING (school_id IN (
    SELECT school_id FROM public.users WHERE id = auth.uid()
));

-- Para transactions: Estudiante ve la suya, padre ve la de sus hijos
CREATE POLICY "Users see own transactions or children's" ON public.transactions
FOR SELECT
USING (
    auth.uid() = student_id 
    OR auth.uid() IN (
        SELECT parent_id FROM parent_student_links 
        WHERE student_id = transactions.student_id
    )
);
```

---

### 4. **Falta Tabla: schools**

**Problema**:
- ‚ùå No existe tabla schools
- ‚ùå school_id no tiene referencia

**Soluci√≥n**:
```sql
CREATE TABLE public.schools (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    country VARCHAR(100),
    city VARCHAR(100),
    business_model JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

### 5. **Falta Tabla: users**

**Problema**:
- ‚ùå Solo hay auth.users (de Supabase Auth)
- ‚ùå No hay perfil completo (rol, escuela, datos adicionales)
- ‚ùå Sin relaci√≥n escuela-usuario

**Soluci√≥n**:
```sql
CREATE TABLE public.users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    auth_id UUID REFERENCES auth.users(id),
    school_id UUID REFERENCES public.schools(id),
    email VARCHAR(255) NOT NULL,
    role VARCHAR(50), -- 'SUPER_ADMIN', 'SCHOOL_ADMIN', 'PARENT', 'STUDENT'
    full_name VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

### 6. **Falta Tabla: students**

**Problema**:
- ‚ùå Asume estudiante = auth.users
- ‚ùå Pero estudiante = entidad con nombre, grado, estado

**Soluci√≥n**:
```sql
CREATE TABLE public.students (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    school_id UUID NOT NULL REFERENCES public.schools(id),
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    email VARCHAR(255),
    student_id_number VARCHAR(50) UNIQUE,
    grade VARCHAR(50),
    status VARCHAR(50) DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT NOW()
);

-- Actualizar transactions:
-- Cambiar: student_id UUID REFERENCES auth.users(id)
-- Por: student_id UUID REFERENCES public.students(id)
```

---

## üìä Comparaci√≥n: Actual vs Propuesto

### Schema Actual (Archivo Actual)
```
2 tablas:
‚îú‚îÄ products (id, name, price, category, concessionaire_id)
‚îî‚îÄ transactions (id, student_id, product_id, amount, concessionaire_id)

Problemas: 6 cr√≠ticos
Funcionalidad: 40% (solo lectura b√°sica)
```

### Schema Propuesto (OPCI√ìN 1)
```
3-4 tablas:
‚îú‚îÄ schools (id, name, city)
‚îú‚îÄ products (id, name, price, category, school_id, concessionaire_id)
‚îú‚îÄ transactions (id, student_id, product_id, amount, school_id, concessionaire_id)
‚îî‚îÄ operating_units (id, name, school_id) [OPTIONAL]

Problemas: 0
Funcionalidad: 85% (multi-tenant, seguro)
```

### Schema Propuesto (OPCI√ìN 2 - MI RECOMENDACI√ìN)
```
7 tablas:
‚îú‚îÄ schools
‚îú‚îÄ operating_units
‚îú‚îÄ students
‚îú‚îÄ users
‚îú‚îÄ products
‚îú‚îÄ transactions
‚îî‚îÄ financial_profiles

Problemas: 0
Funcionalidad: 100% (soporta MVP-1 a MVP-3)
```

---

## üéØ Recomendaciones

### Opci√≥n A: Mejora M√≠nima (Archivo Actual + Fixes)
```sql
-- Agregar a ambas tablas:
+ school_id UUID
+ Crear tabla schools
+ Crear tabla operating_units
+ Mejorar RLS policies

Tiempo: 1 hora
Cobertura: 85%
```

### Opci√≥n B: Expansi√≥n Moderada (OPCI√ìN 2 del documento)
```sql
-- Agregar 3 tablas m√°s:
+ students
+ users
+ financial_profiles

Tiempo: 2 horas
Cobertura: 100% (MVP-1 a MVP-3)
```

### Opci√≥n C: Schema Completo (OPCI√ìN 3)
```sql
-- Agregar 11 tablas m√°s (13 total):
+ parent_profiles
+ deposits
+ spending_limits
+ alert_configs
+ alert_logs
+ parent_student_links
+ etc.

Tiempo: 3-4 horas
Cobertura: 100% (MVP-1 a MVP-4)
```

---

## ‚úçÔ∏è Mi Recomendaci√≥n Espec√≠fica

**Para alinearse con nuestro an√°lisis anterior:**

### Si Opci√≥n 1 (R√°pido - 2 d√≠as):
```sql
-- Actualizar migrations/001_initial_schema.sql con:
‚úì Agregar tabla schools
‚úì Agregar school_id a products y transactions
‚úì Crear constraint para concessionaire_id ‚Üí operating_units
‚úì Mejorar RLS policies
‚úì RESULTADO: Archivo listo en 1 hora
```

### Si Opci√≥n 2 (Balanceado - 3 d√≠as) ‚≠ê RECOMENDADO:
```sql
-- Actualizar migrations/001_initial_schema.sql con:
‚úì Agregar 4 tablas m√°s (schools, students, users, financial_profiles)
‚úì Integrar properly con auth.users
‚úì RLS policies completas
‚úì Constraints y validaciones
‚úì RESULTADO: Schema listo en 2-3 horas
```

### Si Opci√≥n 3 (Completo - 4 d√≠as):
```sql
-- Usar el SUPABASE_SCHEMA_PLAN.md completo
‚úì Todas las 13 tablas
‚úì RLS policies exhaustivas
‚úì RESULTADO: Schema enterprise-ready en 4 horas
```

---

## üìù Cambios Espec√≠ficos Propuestos

### 1. Agregar Tabla Schools (ESENCIAL)
```sql
CREATE TABLE public.schools (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    country VARCHAR(100),
    city VARCHAR(100),
    email VARCHAR(255),
    phone VARCHAR(20),
    business_model JSONB DEFAULT '{"setupFee": 25000, "annualFee": 15000}',
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

ALTER TABLE public.schools ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Schools visible to their admins" ON public.schools
FOR SELECT USING (
    id IN (SELECT school_id FROM public.users WHERE auth.uid() = id)
);
```

### 2. Actualizar Products Table
```sql
-- Cambiar:
CREATE TABLE public.products (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone not null default now(),
    name text not null,
    price numeric not null check (price >= 0),
    category text,
    concessionaire_id bigint
);

-- Por:
CREATE TABLE public.products (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    school_id UUID NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    price NUMERIC(10,2) NOT NULL CHECK (price >= 0),
    category VARCHAR(100),
    concessionaire_id UUID,
    is_available BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_products_school_id ON public.products(school_id);
CREATE INDEX idx_products_category ON public.products(category);
```

### 3. Actualizar Transactions Table
```sql
-- Cambiar:
CREATE TABLE public.transactions (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone not null default now(),
    student_id uuid not null,
    product_id bigint not null,
    amount numeric not null check (amount >= 0),
    concessionaire_id bigint,
    constraint fk_student foreign key (student_id) references auth.users(id),
    constraint fk_product foreign key (product_id) references public.products(id)
);

-- Por:
CREATE TABLE public.transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    school_id UUID NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    student_id UUID NOT NULL REFERENCES public.students(id) ON DELETE CASCADE,
    product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE CASCADE,
    amount NUMERIC(12,2) NOT NULL CHECK (amount >= 0),
    type VARCHAR(50) DEFAULT 'PURCHASE', -- 'PURCHASE', 'REFUND', 'DEPOSIT'
    status VARCHAR(50) DEFAULT 'COMPLETED',
    concessionaire_id UUID,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_transactions_school_id ON public.transactions(school_id);
CREATE INDEX idx_transactions_student_id ON public.transactions(student_id);
CREATE INDEX idx_transactions_created_at ON public.transactions(created_at);
```

### 4. Mejorar RLS Policies

```sql
-- Para products:
DROP POLICY "Allow public read access to products" ON public.products;

CREATE POLICY "Users see products from their school" ON public.products
FOR SELECT
USING (school_id IN (
    SELECT school_id FROM public.users WHERE auth_id = auth.uid()
));

CREATE POLICY "School admin can edit products" ON public.products
FOR UPDATE
USING (school_id IN (
    SELECT school_id FROM public.users 
    WHERE auth_id = auth.uid() 
    AND role IN ('SCHOOL_ADMIN', 'SUPER_ADMIN')
));

-- Para transactions:
DROP POLICY "Allow users to read their own transactions" ON public.transactions;

CREATE POLICY "Students see own transactions" ON public.transactions
FOR SELECT
USING (student_id IN (
    SELECT id FROM public.students 
    WHERE auth_id = auth.uid()
));

CREATE POLICY "Parents see children's transactions" ON public.transactions
FOR SELECT
USING (student_id IN (
    SELECT student_id FROM public.parent_student_links 
    WHERE parent_id IN (
        SELECT id FROM public.parent_profiles 
        WHERE auth_id = auth.uid()
    )
));

CREATE POLICY "School admin see all transactions" ON public.transactions
FOR SELECT
USING (school_id IN (
    SELECT school_id FROM public.users 
    WHERE auth_id = auth.uid() 
    AND role IN ('SCHOOL_ADMIN', 'SUPER_ADMIN')
));
```

---

## üìã Checklist de Cambios

- [ ] Crear tabla `schools`
- [ ] Crear tabla `students` (si OPCI√ìN 2+)
- [ ] Crear tabla `users` (si OPCI√ìN 2+)
- [ ] Agregar `school_id` a `products`
- [ ] Agregar `school_id` a `transactions`
- [ ] Cambiar `product_id` de bigint a UUID
- [ ] Cambiar student_id para referenciar `students` en lugar de `auth.users`
- [ ] Agregar indexes para performance
- [ ] Mejorar RLS policies (SELECT, INSERT, UPDATE, DELETE)
- [ ] Agregar constraints (ON DELETE CASCADE)
- [ ] Testar integridad referencial

---

## üöÄ Recomendaci√≥n Final

### Para Avanzar R√°pido:
**Actualiza el migration file a OPCI√ìN 2** (7 tablas core)

Cambios espec√≠ficos:
1. Reemplaza TODO el contenido del archivo migrations/001_initial_schema.sql
2. Usa el schema de SUPABASE_SCHEMA_PLAN.md (Tier 1 + Tier 2, primeras 7 tablas)
3. Mant√©n tu estructura de products y transactions (solo agrega campos)
4. Una vez confirmes OPCI√ìN (1, 2, o 3), te proporciono el SQL exacto completo

---

## ¬øQu√© Hago Ahora?

**Espera tu confirmaci√≥n**:
1. ¬øCu√°l OPCI√ìN eliges? (1, 2, o 3)
2. Una vez confirmes, genero el migration file completo y listo para deployar

**Status**: ‚è≥ Pendiente confirmaci√≥n de opci√≥n
**Acci√≥n**: Confirma opci√≥n y procedo con actualizaci√≥n del archivo
